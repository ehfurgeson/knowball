{% extends "base.html" %}

{% block title %}{{ player_name }} - NBA Stats{% endblock %}

{% block content %}
    <div class="player-header">
        <h1>{{ player_name }}</h1>
        <div class="season-selector">
            <form action="/player/{{ player_name }}" method="get">
                <select name="season" class="season-select" onchange="this.form.submit()">
                    {% for s in available_seasons %}
                        <option value="{{ s }}" {% if s == season %}selected{% endif %}>{{ s }} Season</option>
                    {% endfor %}
                </select>
            </form>
        </div>
    </div>
    
    <div class="stats-grid">
        <div class="summary-card">
            <h2>Season Summary</h2>
            <div class="summary-stats">
                <div class="stat-item">
                    <span class="stat-label">Games Played</span>
                    <span class="stat-value">{{ player_data.shape[0] }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Avg Points</span>
                    <span class="stat-value">{{ "%.1f"|format(player_data['points'].mean()) }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Avg Minutes</span>
                    <span class="stat-value">{{ "%.1f"|format(player_data['minutes'].mean()) }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Highest Points</span>
                    <span class="stat-value">{{ player_data['points'].max() }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Avg Rebounds</span>
                    <span class="stat-value">{{ "%.1f"|format(player_data['rebounds'].mean()) }}</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Avg Assists</span>
                    <span class="stat-value">{{ "%.1f"|format(player_data['assists'].mean()) }}</span>
                </div>
            </div>
        </div>
        
        {% if impressive_performances %}
            <div class="impressive-performances-card">
                <h2>Impressive Performances</h2>
                <div class="performance-list">
                    {% for perf in impressive_performances %}
                        <div class="performance-item">
                            <div class="z-score-badge {% if perf.z_score > 3 %}exceptional{% elif perf.z_score > 2.5 %}excellent{% elif perf.z_score > 2 %}very-good{% else %}good{% endif %}">
                                {{ "%.1f"|format(perf.z_score) }}
                            </div>
                            <div class="performance-details">
                                <span class="stat-type">{{ perf.stat_type.replace('_', ' ').title() }}</span>
                                <span class="stat-value">{{ perf.value }}</span>
                                <span class="game-date">{{ perf.game_date.strftime('%b %d, %Y') }}</span>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}
    </div>
    
    <div class="chart-sections">
        <div class="chart-tabs">
            <button class="chart-tab active" data-tab="scoring">Scoring</button>
            <button class="chart-tab" data-tab="efficiency">Efficiency</button>
            <button class="chart-tab" data-tab="rest">Rest Impact</button>
            <button class="chart-tab" data-tab="distributions">Distributions</button>
        </div>
        
        <div class="chart-content active" id="scoring-content">
            <div class="chart-container full-width">
                <h3>Scoring Trends</h3>
                <div class="chart">
                    {{ scoring_chart|safe }}
                </div>
            </div>
        </div>
        
        <div class="chart-content" id="efficiency-content">
            <div class="chart-container full-width">
                <h3>Scoring Efficiency</h3>
                <div class="chart">
                    {{ efficiency_chart|safe }}
                </div>
            </div>
        </div>
        
        <div class="chart-content" id="rest-content">
            <div class="chart-grid">
                <div class="chart-container">
                    <h3>Points by Rest Days</h3>
                    <div class="chart">
                        {{ rest_days_chart|safe }}
                    </div>
                </div>
                
                {% if back_to_back_chart %}
                    <div class="chart-container">
                        <h3>Back-to-Back Game Performance</h3>
                        <div class="chart">
                            {{ back_to_back_chart|safe }}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="chart-content" id="distributions-content">
            <div class="distribution-selector">
                <label for="dist-stat-select">Select Stat:</label>
                <select id="dist-stat-select">
                    <option value="points">Points</option>
                    <option value="rebounds">Rebounds</option>
                    <option value="assists">Assists</option>
                    <option value="minutes">Minutes</option>
                    <option value="field_goal_percentage">FG%</option>
                </select>
            </div>
            
            <div class="distribution-charts">
                {% for stat, charts in distribution_charts.items() %}
                    {% if '_hist' in stat %}
                        {% set base_stat = stat.replace('_hist', '') %}
                        <div class="distribution-section" id="{{ base_stat }}-distribution" style="display: none;">
                            <div class="chart-grid">
                                <div class="chart-container">
                                    <h3>{{ base_stat.replace('_', ' ').title() }} Distribution</h3>
                                    <div class="chart">
                                        {{ charts|safe }}
                                    </div>
                                </div>
                                
                                {% if base_stat + '_time' in distribution_charts %}
                                    <div class="chart-container">
                                        <h3>{{ base_stat.replace('_', ' ').title() }} Timeline</h3>
                                        <div class="chart">
                                            {{ distribution_charts[base_stat + '_time']|safe }}
                                        </div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            </div>
        </div>
    </div>
    
    <div class="recent-games">
        <h2>Recent Games</h2>
        <div class="games-table-container">
            <table class="games-table">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Matchup</th>
                        <th>MIN</th>
                        <th>PTS</th>
                        <th>REB</th>
                        <th>AST</th>
                        <th>STL</th>
                        <th>BLK</th>
                        <th>+/-</th>
                    </tr>
                </thead>
                <tbody>
                    {% for index, row in player_data.sort_values('game_date', ascending=False).iterrows() %}
                        <tr>
                            <td>{{ row['game_date'].strftime('%b %d, %Y') }}</td>
                            <td>{{ row['home_team'] }} vs {{ row['away_team'] }}</td>
                            <td>{{ "%.1f"|format(row['minutes']) }}</td>
                            <td>{{ row['points'] }}</td>
                            <td>{{ row['rebounds'] }}</td>
                            <td>{{ row['assists'] }}</td>
                            <td>{{ row['steals'] }}</td>
                            <td>{{ row['blocks'] }}</td>
                            <td class="{% if row['plus_minus'] > 0 %}positive{% elif row['plus_minus'] < 0 %}negative{% endif %}">
                                {{ row['plus_minus'] }}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Tab functionality
        const chartTabs = document.querySelectorAll('.chart-tab');
        const chartContents = document.querySelectorAll('.chart-content');
        
        chartTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                // Remove active class from all tabs and contents
                chartTabs.forEach(t => t.classList.remove('active'));
                chartContents.forEach(c => c.classList.remove('active'));
                
                // Add active class to current tab
                tab.classList.add('active');
                
                // Show corresponding content
                const contentId = tab.dataset.tab + '-content';
                document.getElementById(contentId).classList.add('active');
                
                // If distributions tab, show the first distribution by default
                if (tab.dataset.tab === 'distributions') {
                    showDistribution('points');
                }
            });
        });
        
        // Distribution selector functionality
        const distStatSelect = document.getElementById('dist-stat-select');
        
        if (distStatSelect) {
            distStatSelect.addEventListener('change', () => {
                const selectedStat = distStatSelect.value;
                showDistribution(selectedStat);
            });
            
            // Show points distribution by default
            showDistribution('points');
        }
        
        function showDistribution(statType) {
            // Hide all distribution sections
            const distSections = document.querySelectorAll('.distribution-section');
            distSections.forEach(section => {
                section.style.display = 'none';
            });
            
            // Show selected distribution
            const selectedSection = document.getElementById(statType + '-distribution');
            if (selectedSection) {
                selectedSection.style.display = 'block';
            }
        }
    });
</script>
{% endblock %}